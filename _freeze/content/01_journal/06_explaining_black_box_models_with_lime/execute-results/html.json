{
  "hash": "fc5df4a70fb205f8c8d6eb99848a90f6",
  "result": {
    "markdown": "---\ntitle: \"Explaining Black-Box Models with LIME\"\nauthor: \"Tommy Weber\"\n---\n\n\n### Repeat of previous Sections\n\n\n::: {.cell hash='06_explaining_black_box_models_with_lime_cache/html/unnamed-chunk-1_ae1fb229a64c0e484fc34b75fb9fcede'}\n\n```{.r .cell-code  code-fold=\"true\"}\n# LIME FEATURE EXPLANATION ----\n\n# 1. Setup ----\n\n# Load Libraries \n\nlibrary(h2o)\nlibrary(rsample)\nlibrary(recipes)\nlibrary(readxl)\nlibrary(tidyverse)\nlibrary(tidyquant)\nlibrary(lime)\n\n# Load Data\nemployee_attrition_tbl <- read.csv(\"../../../employee_attrition.csv\")\n\npath_data_definitions <- \"../../../data_definitions.xlsx\"\ndefinitions_raw_tbl   <- read_excel(path_data_definitions, sheet = 1, col_names = FALSE)\n\nprocess_hr_data_readable <- function(data, definitions_tbl) {\n  \n  definitions_list <- definitions_tbl %>%\n    fill(...1, .direction = \"down\") %>%\n    filter(!is.na(...2)) %>%\n    separate(...2, into = c(\"key\", \"value\"), sep = \" '\", remove = TRUE) %>%\n    rename(column_name = ...1) %>%\n    mutate(key = as.numeric(key)) %>%\n    mutate(value = value %>% str_replace(pattern = \"'\", replacement = \"\")) %>%\n    split(.$column_name) %>%\n    map(~ select(., -column_name)) %>%\n    map(~ mutate(., value = as_factor(value))) \n  \n  for (i in seq_along(definitions_list)) {\n    list_name <- names(definitions_list)[i]\n    colnames(definitions_list[[i]]) <- c(list_name, paste0(list_name, \"_value\"))\n  }\n  \n  data_merged_tbl <- list(HR_Data = data) %>%\n    append(definitions_list, after = 1) %>%\n    reduce(left_join) %>%\n    select(-one_of(names(definitions_list))) %>%\n    set_names(str_replace_all(names(.), pattern = \"_value\", \n                              replacement = \"\")) %>%\n    select(sort(names(.))) %>%\n    mutate_if(is.character, as.factor) %>%\n    mutate(\n      BusinessTravel = BusinessTravel %>% fct_relevel(\"Non-Travel\", \n                                                      \"Travel_Rarely\", \n                                                      \"Travel_Frequently\"),\n      MaritalStatus  = MaritalStatus %>% fct_relevel(\"Single\", \n                                                     \"Married\", \n                                                     \"Divorced\")\n    )\n  \n  return(data_merged_tbl)\n  \n}\n\nemployee_attrition_readable_tbl <- process_hr_data_readable(employee_attrition_tbl, definitions_raw_tbl)\n\n# Split into test and train\nset.seed(seed = 1113)\nsplit_obj <- rsample::initial_split(employee_attrition_readable_tbl, prop = 0.85)\n\n# Assign training and test data\ntrain_readable_tbl <- training(split_obj)\ntest_readable_tbl  <- testing(split_obj)\n\n# ML Preprocessing Recipe \nrecipe_obj <- recipe(Attrition ~ ., data = train_readable_tbl) %>%\n                step_zv(all_predictors()) %>%\n                step_mutate_at(c(\"JobLevel\", \"StockOptionLevel\"), fn = as.factor) %>% \n                prep()\n\nrecipe_obj\n\ntrain_tbl <- bake(recipe_obj, new_data = train_readable_tbl)\ntest_tbl  <- bake(recipe_obj, new_data = test_readable_tbl)\n\n# 2. Models ----\n\nh2o.init()\n\nautoml_leader <- h2o.loadModel(\"../../my_models/Attr_Model/StackedEnsemble_AllModels_3_AutoML_1_20230611_110811\")\n```\n:::\n\n\n---\n\n### Explanation\n\n\n::: {.cell hash='06_explaining_black_box_models_with_lime_cache/html/unnamed-chunk-2_25f590abd60d569227071d9b1193b2cb'}\n\n```{.r .cell-code}\npredictions_tbl <- automl_leader %>% \n  h2o.predict(newdata = as.h2o(test_tbl)) %>% \n  as_tibble() %>% \n  bind_cols(\n    test_tbl %>% \n      select(Attrition, EmployeeNumber)\n  )\n\n\nexplainer <- train_tbl %>% \n  select(-Attrition) %>% \n  lime(\n    model = automl_leader,\n    bin_continuous = TRUE,\n    n_bins = 4,\n    quantile_bins = TRUE\n  )\n\n\nexplanation <- test_tbl %>% \n  slice(1:20) %>% \n  select(-Attrition) %>% \n  lime::explain(\n    explainer = explainer,\n    n_labels = 1,\n    n_features = 8,\n    n_permutations = 5000,\n    kernel_width = 1.0\n  )\n```\n:::\n\n\n---\n\n### Challenge, Part 1\n\n\n::: {.cell hash='06_explaining_black_box_models_with_lime_cache/html/unnamed-chunk-3_7c45cf7d0cede46dc877ae8f61bee830'}\n\n```{.r .cell-code}\ncustom_plot_features <- function(explanation, case_id) {\n  \n  case_expl <- explanation %>% \n    filter(case == case_id) %>% \n    as_tibble() %>% \n    arrange(feature_weight %>% abs()) %>%\n    mutate(feature_desc = as_factor(feature_desc)) %>% \n    mutate(is_support = feature_weight > 0)\n  \n  label <- case_expl$label[1]\n  probability <- round(case_expl$label_prob[1], digits = 2)\n  explanation_fit <- round(case_expl$model_r2[1], digits = 2)\n  \n  case_expl %>%   \n    ggplot() +\n    \n    geom_col(aes(x = feature_desc, y = feature_weight, fill = is_support)) +\n    \n    coord_flip() +\n    \n    scale_fill_discrete(labels = c(\"Contradicts\", \"Supports\")) +\n    \n    labs(\n      subtitle = str_c(paste0(\"Case: \", case_id),\n                       paste0(\"Label: \", label),\n                       paste0(\"Probability: \", probability),\n                       paste0(\"Explanation Fit: \", explanation_fit),\n                       sep = \"\\n\"),\n      x = \"Feature\",\n      y = \"Weight\"\n    ) +\n    \n    theme(\n      legend.title = element_blank(),\n      legend.position = \"bottom\"\n    )\n}\n```\n:::\n\n::: {.cell hash='06_explaining_black_box_models_with_lime_cache/html/unnamed-chunk-4_54556f545fa64f989db176c56f3ba208'}\n\n```{.r .cell-code}\ncustom_plot_features(explanation, 8)\n```\n\n::: {.cell-output-display}\n![](06_explaining_black_box_models_with_lime_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n---\n\n### Challenge, Part 2\n\n\n::: {.cell hash='06_explaining_black_box_models_with_lime_cache/html/unnamed-chunk-5_fa89d3e61f5f4ce55ef762c38152d2b5'}\n\n```{.r .cell-code}\nexplanation %>% \n  mutate(case = as_factor(case)) %>% \n  \n  ggplot(aes(x = case, y = feature_desc, fill = feature_weight)) +\n  \n  geom_tile() +\n  \n  facet_wrap(vars(label)) +\n  \n  scale_fill_continuous(name = \"Feature weight\") +\n  \n  labs(\n    x = \"Case\",\n    y = \"Feature\",\n  ) +\n  \n  theme(\n    axis.text.x = element_text(angle=45, hjust=1),\n    panel.grid = element_blank(),\n    panel.border = element_rect(color = \"black\", fill = \"transparent\"),\n    strip.background = element_blank(),\n    strip.text = element_text(hjust = 0.0)\n    )\n```\n\n::: {.cell-output-display}\n![](06_explaining_black_box_models_with_lime_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}